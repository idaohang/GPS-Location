#include "Sys.h"
#include "GSM.h"
#include "key.h"
Datapack uartbuf;
u8 UARTflag=0;
u8 display_flag = 1;

u8 bignum[][5*24] = {
{0x00,0x00,0xE0,0xF8,0xFC,0xFE,0xFE,0xFE,0xFF,0xFF,0x1F,0x1F,0x1F,0x1F,0xFF,0xFF,
0xFF,0xFE,0xFE,0xFC,0xF8,0xE0,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
0x00,0x00,0x0F,0x1F,0x3F,0x7F,0x7F,0x7F,0xFF,0xFF,0xF8,0xF8,0xF8,0xF8,0xFF,0xFF,
0x7F,0x7F,0x7F,0x3F,0x1F,0x07,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0xE0,0xF0,0xF8,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,
0x03,0x03,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00},//1
{0x00,0x00,0x00,0xE0,0xF8,0xFC,0xFE,0xFE,0xFF,0xFF,0xFF,0x1F,0x1F,0x3F,0xFF,0xFF,
0xFF,0xFE,0xFE,0xFC,0xF8,0xC0,0x00,0x00,0x00,0x00,0x00,0x7F,0x7F,0x7F,0x7F,0x7F,
0x7F,0x7F,0x7F,0x00,0x00,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xE0,0xF8,0xFE,0xFF,0xFF,0xFF,
0xFF,0x7F,0x1F,0x0F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xF0,0xFC,
0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x1F,0x07,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF9,0xF8,0xF8,0xF8,
0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0x00,0x00},//2
{0x00,0x00,0x00,0xF0,0xF8,0xFC,0xFE,0xFE,0xFF,0xFF,0xFF,0x1F,0x1F,0x1F,0xFF,0xFF,
0xFE,0xFE,0xFE,0xFC,0xF8,0xF0,0x00,0x00,0x00,0x00,0x00,0x3F,0x3F,0x3F,0x3F,0x3F,
0x3F,0x3F,0x3F,0x00,0x00,0x80,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x00,0x00,
0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x8F,0x0F,0x0F,0x1F,0xFF,0xFF,
0xFF,0xFF,0xFF,0xF9,0xF0,0xC0,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
0x00,0x00,0x00,0x0F,0x1F,0x3F,0x7F,0x7F,0xFF,0xFF,0xFF,0xF8,0xF8,0xF8,0xFF,0xFF,
0xFF,0x7F,0x7F,0x3F,0x1F,0x07,0x00,0x00},//3
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xF8,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0xFE,0xFF,
0xFF,0xFF,0xFF,0x7F,0x0F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,
0x00,0x00,0xC0,0xF8,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x07,0x00,0x00,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0xE0,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xC3,0xC0,0xC0,0xC0,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0xC0,0xC0,
0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0x07,0x07,0x07},//4
{0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x1F,0x1F,0x1F,0x1F,
0x1F,0x1F,0x1F,0x1F,0x1F,0x03,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xC0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xC0,0x80,0x00,0x00,0x00,
0x00,0x00,0x00,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x07,0x03,0x03,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
0x00,0x00,0x00,0x0F,0x3F,0x3F,0x7F,0x7F,0xFF,0xFF,0xFF,0xF8,0xF8,0xF8,0xFF,0xFF,
0x7F,0x7F,0x7F,0x3F,0x1F,0x0F,0x00,0x00},//5
{0x00,0x00,0x00,0xE0,0xF8,0xFC,0xFE,0xFE,0xFF,0xFF,0xFF,0x1F,0x1F,0x3F,0xFF,0xFF,
0xFF,0xFE,0xFE,0xFC,0xF8,0xE0,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xC0,0xE0,0xE0,0xEF,0xEF,0xEF,0xEF,0xCF,0xCF,0x8F,0x0F,0x00,0x00,
0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x03,0x03,0x03,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
0x00,0x00,0x00,0x0F,0x1F,0x3F,0x7F,0x7F,0xFF,0xFF,0xFF,0xF8,0xF8,0xF8,0xFF,0xFF,
0x7F,0x7F,0x7F,0x3F,0x1F,0x0F,0x00,0x00},//6
{0x00,0x00,0x00,0x00,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0xDF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0xF0,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x03,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xF8,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0x7F,0x0F,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0xFE,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0xC0,0xF8,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x0F,0x01,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//7
{0x00,0x00,0x00,0xF0,0xF8,0xFC,0xFE,0xFE,0xFF,0xFF,0xFF,0x1F,0x1F,0x1F,0xFF,0xFF,
0xFE,0xFE,0xFE,0xFC,0xF8,0xF0,0x00,0x00,0x00,0x00,0x00,0x7F,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x00,0x00,
0x00,0x00,0x00,0xC0,0xF1,0xFB,0xFB,0xFF,0xFF,0xFF,0xFF,0x1F,0x1F,0x1F,0xFF,0xFF,
0xFF,0xFF,0xFB,0xFB,0xF1,0xC0,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
0x00,0x00,0x00,0x0F,0x1F,0x3F,0x7F,0x7F,0xFF,0xFF,0xFF,0xF8,0xF8,0xF8,0xFF,0xFF,
0xFF,0x7F,0x7F,0x3F,0x1F,0x0F,0x00,0x00},//8
{0x00,0x00,0x00,0xE0,0xF8,0xFC,0xFE,0xFE,0xFE,0xFF,0xFF,0x1F,0x1F,0x1F,0xFF,0xFF,
0xFE,0xFE,0xFE,0xFC,0xF8,0xF0,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
0x00,0x00,0x00,0x07,0x1F,0x3F,0x3F,0x7F,0x7F,0x7F,0x7F,0x7C,0x7C,0x3C,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
0x00,0x00,0x00,0x0F,0x1F,0x3F,0x7F,0x7F,0xFF,0xFF,0xFF,0xF8,0xF8,0xF8,0xFF,0xFF,
0xFF,0x7F,0x7F,0x3F,0x1F,0x07,0x00,0x00}};


u8 maohao[]={0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x00,0x00,0x00,0x00,0x00};
/*void setTime(void)
{
  time buf;
  buf.year=14;
  buf.mouth=9;
  buf.day=8;
  buf.hour=1;
  buf.min=10;
  buf.sec=50;
  DSWrite(&buf);
}*/
void SendSignal(char i)
{
  setCharsOLED("status",0,7);
  if(i=='V')
  {
    setCharsOLED(": No Signal",33,7);
  }
  else
  {
    setCharsOLED(": Send Now",33,7);
  }
}

void showYMD(time* temp)
{
  Dis_fnum(temp->year,11,1);
  setCharsOLED("-",22,1);
  Dis_fnum(temp->mouth,28,1);
  if(temp->mouth>9)
  {
    setCharsOLED("-",40,1);
    Dis_fnum(temp->day,46,1);
  }
  else 
  {
    setCharsOLED("-",35,1);
    Dis_fnum(temp->day,41,1);
  }
}

void Tostring(char* str,time* temp)
{
  u8 hour,min;
  hour = temp->hour;
  min = temp->min;
  str[0] = hour/10;
  str[1] = hour%10;
  str[2] = min/10;
  str[3] = min%10;
}
void showbignum(time* temp)
{
  int i,j;
  char str[4];
  Tostring(str,temp);
   //addrOLED(0,0);
  for(i=0;i<5;i++)
  {
    addrOLED(0,1+i);
    for(j=0;j<24;j++)
    {
      WriteIIC_Dat(bignum[str[0]][i*24+j]);
    }
  }
  for(i=0;i<5;i++)
  {
    addrOLED(25,i+2);
    for(j=0;j<24;j++)
    {
      WriteIIC_Dat(bignum[str[1]][i*24+j]);
    }
  }
  for(i=0;i<5;i++)
  {
    addrOLED(50,i+2);
    for(j=0;j<17;j++)
    {
      WriteIIC_Dat(maohao[i*17+j]);
    }
  }
  for(i=0;i<5;i++)
  {
    addrOLED(68,i+2);
    for(j=0;j<24;j++)
    {
      WriteIIC_Dat(bignum[str[2]][i*24+j]);
    }
  }
  for(i=0;i<5;i++)
  {
    addrOLED(94,i+2);
    for(j=0;j<24;j++)
    {
      WriteIIC_Dat(bignum[str[3]][i*24+j]);
    }
  }
  
}


void showTime(u8* diff ,char* diff1)
{
  time temp;
  DSRead(&temp); 
  if(*diff != temp.min)
  {
    clear_OLED();
    *diff = temp.min;
    showYMD(&temp);
    showbignum(&temp);
    SendSignal(*diff1);
  }
}

int main(void)
{     
  u8 i,timediff = 0;  
  char lati[10],loni[11],signaldiff = 'V';
  time Realtime;
  Datapack temp;
  Sys_init();
  clear_OLED();
  setCharsOLED("Loading Now",30,3);
  keyinit();
  Ds1302_Init();
  httpInit();
  clear_OLED();
  uartbuf.countlat = 0;
  uartbuf.countlon = 0;
  uartbuf.countUTC = 0;
  Menu();
  clear_OLED();
  showTime(&timediff,&signaldiff);
  
  rim();
  while(1)
  { 
    
    if(readkey())
    {
      if(display_flag)
      {
	display_flag = 0;
	clear_OLED();
      }
      else
      {
	display_flag = 1;
	clear_OLED();
	timediff = 99;
	showTime(&timediff,&signaldiff); 
      }
    }
    if(UARTflag==1)
    {
      if(display_flag)
      {
      	showTime(&timediff,&signaldiff); 
      }
      if(uartbuf.status=='A')
      {
	temp = uartbuf;
	//Sendpack(&uartbuf);
	for(i=0;i<10;i++)
	{
	  if(((uartbuf.longitude[i]>='0' && uartbuf.longitude[i] <='9') || uartbuf.longitude[i] =='.'))
	  {
	    loni[i] = uartbuf.longitude[i];
	    lati[i] = uartbuf.latitude[i];
	  }
	  else
	  {
	    //sendChars("AB");
	    break;
	  }
	  if(i==9)
	  {
	    loni[10] = uartbuf.longitude[10];
	    temp = uartbuf;
	    Send_PostMessage(&temp,&lati,&loni);
	    if(signaldiff!='A')
	    {
	      if(display_flag==1)
	      {
	      	SendSignal('A');
	      }
	      signaldiff = 'A';
	    }
	    uartbuf.countlat = 0;
	    uartbuf.countlon = 0;
	    uartbuf.countUTC = 0;
	    uartbuf.status = 'V';
	  }
	}
	
      }
      else
      {
	if(signaldiff!='V')
	{
	  if(display_flag == 1)
	  {
	      signaldiff = 'V';
	  }
	  SendSignal('V');
	}
      }
      UARTflag=0;	
      rim();
    }
    //printf("¶¨");
    //delay_ms(1);
    //addrOLED(1,2); 
    //setCharOLED('X');
  }  
}

u8 uarttemp;
#pragma vector = UART3_RX_vector
__interrupt void UART3_RXxx(void)
{
  uarttemp=UART3->DR;  
  UARTflag=GPRMC_Analyze(uarttemp,&uartbuf);
  //UART_SendChar(uarttemp);
  UART3->SR&=~(0x20);
}



